name: Security - Gitleaks

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      
      - name: Comment on PR (if secrets found)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ðŸš¨ **Gitleaks found potential secrets in this PR!**\n\nPlease review the security scan results and remove any exposed secrets before merging.\n\nIf these are false positives, add them to `.gitleaks.toml` allowlist.'
              });
            }
