name: Auto-merge Approved PRs

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge if approved
    runs-on: ubuntu-latest
    if: |
      github.event.review.state == 'approved' ||
      (github.event.check_suite.conclusion == 'success' && github.event.check_suite.pull_requests[0] != null)
    
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber;
            
            if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.review) {
              prNumber = context.payload.review.pull_request.number;
            } else if (context.payload.check_suite && context.payload.check_suite.pull_requests.length > 0) {
              prNumber = context.payload.check_suite.pull_requests[0].number;
            }
            
            if (!prNumber) {
              console.log('No PR number found');
              return { should_merge: false };
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Check if PR is from Copilot or trusted automation
            const isFromCopilot = pr.user.login === 'Copilot' || 
                                  pr.user.type === 'Bot' ||
                                  (pr.user.id && pr.user.id === 198982749); // Copilot's user ID
            
            // Check if PR has been approved
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const hasApproval = reviews.some(review => review.state === 'APPROVED');
            
            // Check if all checks have passed
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            // Only pass if checks have run AND all passed
            const allChecksPassed = checks.check_runs.length > 0 && 
              checks.check_runs.every(check => 
                check.conclusion === 'success' || 
                check.conclusion === 'skipped' ||
                check.conclusion === 'neutral'
              );
            
            const shouldMerge = isFromCopilot && hasApproval && allChecksPassed && !pr.draft;
            
            core.setOutput('pr_number', prNumber);
            core.setOutput('should_merge', shouldMerge);
            core.setOutput('pr_title', pr.title);
            
            return {
              pr_number: prNumber,
              should_merge: shouldMerge,
              pr_title: pr.title
            };
      
      - name: Auto-merge PR
        if: steps.pr.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ steps.pr.outputs.pr_number }}';
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Auto-merge: ${{ steps.pr.outputs.pr_title }} (#${prNumber})`,
                commit_message: 'Automatically merged after validation and approval.'
              });
              
              console.log(`Successfully merged PR #${prNumber}`);
              
              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'üéâ This PR has been automatically merged after passing all checks and receiving approval.\n\n_Automated merge by auto-merge workflow._'
              });
            } catch (error) {
              console.log('Failed to merge PR:', error.message);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è Automatic merge failed: ${error.message}\n\nPlease merge manually.`
              });
            }
      
      - name: Skip merge
        if: steps.pr.outputs.should_merge != 'true'
        run: echo "PR does not meet auto-merge criteria"
