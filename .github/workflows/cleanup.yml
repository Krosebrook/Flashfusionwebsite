name: Cleanup

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  # Clean up old workflow runs
  cleanup-runs:
    name: Cleanup Workflow Runs
    runs-on: ubuntu-latest
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10

  # Clean up stale branches
  cleanup-branches:
    name: Cleanup Stale Branches
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Delete stale branches
        run: |
          echo "üßπ Cleaning up stale branches..."
          
          # Get list of merged branches older than 30 days (excluding protected branches)
          STALE_BRANCHES=$(git branch -r --merged origin/main | \
            grep -v 'main\|develop\|HEAD' | \
            sed 's/origin\///' | \
            while read branch; do
              # Check if branch is older than 30 days
              LAST_COMMIT=$(git log -1 --format=%ct origin/$branch 2>/dev/null || echo "0")
              THIRTY_DAYS_AGO=$(date -d "30 days ago" +%s)
              if [ "$LAST_COMMIT" -lt "$THIRTY_DAYS_AGO" ] 2>/dev/null; then
                echo "$branch"
              fi
            done)
          
          if [ -z "$STALE_BRANCHES" ]; then
            echo "No stale branches to clean up."
          else
            echo "Found stale branches:"
            echo "$STALE_BRANCHES"
            
            # Uncomment the following to actually delete branches
            # for branch in $STALE_BRANCHES; do
            #   echo "Deleting branch: $branch"
            #   git push origin --delete "$branch"
            # done
            
            echo "‚ö†Ô∏è Dry run complete. Uncomment the deletion lines to enable actual cleanup."
          fi

  # Clean up preview deployments
  cleanup-previews:
    name: Cleanup Preview Deployments
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old previews
        run: |
          echo "üßπ Cleaning up old preview deployments..."
          # Add your preview cleanup logic here
          # This depends on your deployment provider
          echo "‚úÖ Preview cleanup complete (placeholder)"

  # Summary
  summary:
    name: Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-runs, cleanup-branches, cleanup-previews]
    if: always()
    steps:
      - name: Report cleanup status
        run: |
          echo "üìä Cleanup Summary"
          echo "==================="
          echo "Workflow Runs Cleanup: ${{ needs.cleanup-runs.result }}"
          echo "Branches Cleanup: ${{ needs.cleanup-branches.result }}"
          echo "Previews Cleanup: ${{ needs.cleanup-previews.result }}"
